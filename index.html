<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Persistency Calculator ‚Äî Apple-style Report</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  /* Apple-style minimal UI */
  :root{
    --bg:#f5f5f7;
    --card:#ffffff;
    --muted:#6b6b6f;
    --line:#e9e9ee;
    --accent:#0071e3;
    --title:#111;
    --table-head:#f2f5f8;
    --radius:12px;
    --maxw:900px;
  }

  html,body{height:100%;}
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    background:var(--bg);
    margin:0;
    padding:28px;
    color:var(--title);
    -webkit-font-smoothing:antialiased;
  }

  .wrap{
    max-width:var(--maxw);
    margin:0 auto;
  }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    padding:22px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  }

  h1{
    margin:0 0 8px 0;
    font-size:18px;
    letter-spacing:-0.2px;
    text-align:center;
    font-weight:700;
  }

  .meta {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:18px;
  }
  .meta-left{ color:var(--muted); font-size:13px; line-height:1.45; text-align:left; }
  .meta-right{ color:var(--muted); font-size:13px; text-align:right; min-width:160px; }

  textarea, select {
    width:100%;
    box-sizing:border-box;
    border-radius:10px;
    border:1px solid var(--line);
    padding:12px;
    font-size:14px;
    resize:vertical;
    background:white;
    font-family:inherit;
    color:var(--title);
  }

  .row{display:flex; gap:12px; margin-top:12px;}
  .col{flex:1;}

  button{
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    font-size:14px;
  }
  button.secondary{
    background:transparent;
    color:var(--accent);
    border:1px solid var(--accent);
    font-weight:600;
  }

  #result{
    margin-top:16px;
    text-align:left;
  }

  .summary-grid{
    display:flex;
    gap:12px;
    margin-top:12px;
    flex-wrap:wrap;
  }
  .card-small{
    background:#fff;
    border-radius:10px;
    padding:12px;
    min-width:150px;
    box-shadow:none;
    border:1px solid var(--line);
  }
  .card-small .label{ color:var(--muted); font-size:12px; }
  .card-small .value{ font-weight:700; font-size:16px; margin-top:6px; }

  .suggestion-box{
    margin-top:14px;
    padding:12px;
    border-radius:10px;
    background:#fff9f3;
    border:1px solid #ffe2c7;
    color:#4e342e;
  }

  pre#rawOutput{
    display:none;
    background:#fbfbfd;
    border:1px solid var(--line);
    padding:10px;
    border-radius:8px;
    margin-top:12px;
    max-height:260px;
    overflow:auto;
    white-space:pre-wrap;
    text-align:left;
  }

  footer.small{
    margin-top:18px;
    color:var(--muted);
    font-size:12px;
    text-align:center;
  }

  @media (max-width:600px){
    .meta{flex-direction:column; align-items:stretch;}
    .meta-right{ text-align:left; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="meta">
        <div class="meta-left">
          <div id="reportDate">Report Date: 11/07/2025</div>
          <div id="persistBlock">Persistency Block: 01-JUL-2023 to 30-JUN-2024</div>
        </div>
        <div style="flex:1"></div>
        <div class="meta-right">
          <div style="font-weight:700; font-size:14px;" id="agentName">Agent: JOHN DOE</div>
        </div>
      </div>

      <h1>Persistency Calculator Report</h1>

      <details style="margin-top:12px;">
        <summary style="cursor:pointer; color:var(--muted);">üìò Show Guide</summary>
        <div style="margin-top:10px; color:var(--muted); font-size:13px;">
          Paste cleaned CSV-style lines into the box below in this format:
          <div style="margin-top:6px; background:#fafafa; border:1px solid var(--line); padding:8px; border-radius:6px; font-family:monospace; font-size:13px;">
            PolicyNo, Name, MonthsPaid, PsistANP, Status, PersistencyBlock, ReportDate
          </div>
        </div>
      </details>

      <div style="margin-top:12px;">
        <textarea id="dataInput" rows="8" placeholder="Paste policy data here (CSV lines)..."></textarea>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="col">
          <select id="persistencyType">
            <option value="13">13-Month Persistency</option>
            <option value="12">12-Month Persistency</option>
          </select>
        </div>
        <div style="width:150px;">
          <button onclick="calculate()">Calculate</button>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="secondary" id="toggleDebug" onclick="toggleDebug()">Show Raw Persistency</button>
        <button onclick="generateStructuredPDF()">üìÑ Generate Formal Report (PDF)</button>
      </div>

      <div id="result"></div>
      <pre id="rawOutput"></pre>

      <footer class="small">Generated by Persistency Calculator Tool ‚Äî Apple-style report</footer>
    </div>
  </div>

<script>
/* ========== Parsing and Calculation (robust) ========== */
let policies = [];
let lastCalc = {
  totalANP:0,
  persistedANP:0,
  roundedPersistency:0,
  shortfall:0,
  recovering: [],
  threshold:13
};

function parseInputToPolicies() {
  policies = [];
  const raw = document.getElementById("dataInput").value.trim();
  if (!raw) return policies;
  const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
  for (let line of lines) {
    // split but allow names with commas
    const parts = line.split(",").map(s => s.trim());
    if (parts.length < 7) continue;
    const policyNo = parts[0];
    if (!/^\d{5,12}$/.test(policyNo)) continue;
    const reportDate = parts[parts.length - 1];
    const persistencyBlock = parts[parts.length - 2];
    const status = parts[parts.length - 3];
    const anpStr = parts[parts.length - 4];
    const monthsPaidStr = parts[parts.length - 5];
    const name = parts.slice(1, parts.length - 5).join(", ");

    const monthsPaid = parseInt(monthsPaidStr, 10);
    const anp = parseFloat((anpStr || "").replace(/,/g, ''));

    if (isNaN(anp) || anp <= 0) continue;

    policies.push({
      policyNo, name, monthsPaid, monthsPaidStr, anp, anpStr, status, persistencyBlock, reportDate
    });
  }
  return policies;
}

function manulifeRound(value) {
  let str = value.toFixed(4);
  let num = parseFloat(str);
  num = parseFloat(num.toFixed(3));
  num = parseFloat(num.toFixed(2));
  num = parseFloat(num.toFixed(1));
  return parseFloat(num.toFixed(1));
}

function calculate() {
  parseInputToPolicies();
  const threshold = parseInt(document.getElementById("persistencyType").value || "13", 10);
  lastCalc.threshold = threshold;

  let totalANP = 0;
  let persistedANP = 0;
  let saveable = [];
  let unqualified = [];

  for (let p of policies) {
    totalANP += p.anp;
    if (p.monthsPaid >= threshold) {
      persistedANP += p.anp;
    } else {
      saveable.push(p);
    }
  }

  // Sort saveable according to your logic:
  // 1) Inforce (IP) first, ordered by monthsPaid desc, then anp desc
  // 2) Then lapsed (LC, LA, etc.), ordered similarly
  const isLapsed = s => (s && s.toUpperCase().startsWith("L")) || s.toUpperCase()==="LA" || s.toUpperCase()==="LC" || s.toUpperCase()==="LR" || s.toUpperCase()==="TC";
  const statusPriority = s => {
    if (!s) return 99;
    s = s.toUpperCase();
    if (s === "IP") return 1;
    // keep lapsed codes as second priority (LC/LA/others)
    if (s.startsWith("L") || s === "LA" || s === "LC" || s === "LR") return 2;
    if (s === "TC") return 3;
    return 99;
  };

  saveable.sort((a,b) => {
    const pa = statusPriority(a.status);
    const pb = statusPriority(b.status);
    if (pa !== pb) return pa - pb;
    if (b.monthsPaid !== a.monthsPaid) return b.monthsPaid - a.monthsPaid;
    return b.anp - a.anp;
  });

  // Build suggested recovering list until shortfall reached
  const targetANP = totalANP * 0.85;
  const shortfall = Math.max(0, targetANP - persistedANP);

  let added = 0;
  const recovering = [];
  for (let s of saveable) {
    if (added >= shortfall) break;
    recovering.push(s);
    added += s.anp;
  }

  // Prepare status labels
  const statusLabels = { "IP":"IP (inforce)", "LC":"LC (lapsed)", "LA":"LA (lapsed)", "TC":"TC (surrendered)" };

  const roundedPersistency = manulifeRound(totalANP === 0 ? 0 : (persistedANP / totalANP) * 100);

  // store last calc for PDF generation
  lastCalc = {
    policies,
    totalANP,
    persistedANP,
    roundedPersistency,
    shortfall,
    recovering,
    threshold,
    targetANP
  };

  // Render result to UI
  const resultEl = document.getElementById("result");
  const statusMet = roundedPersistency >= 85;
  let html = `
    <div class="summary-grid">
      <div class="card-small"><div class="label">Total ANP</div><div class="value">RM ${totalANP.toFixed(2)}</div></div>
      <div class="card-small"><div class="label">Persisted ANP</div><div class="value">RM ${persistedANP.toFixed(2)}</div></div>
      <div class="card-small"><div class="label">Persistency %</div><div class="value">${roundedPersistency}%</div></div>
      <div class="card-small"><div class="label">Target</div><div class="value">85%</div></div>
      <div class="card-small"><div class="label">Status</div><div class="value">${statusMet ? "‚úÖ Met" : "‚ùå Not Met"}</div></div>
    </div>
  `;

  if (!statusMet) {
    html += `<div class="suggestion-box"><strong>Shortfall:</strong> You need an additional <b>RM ${Math.max(0, (lastCalc.shortfall)).toFixed(2)}</b> to reach 85%.<br/><br/>
    <strong>Suggested saveable policies (priority: inforce highest months paid ‚Üí lapsed):</strong>
    <ul style="margin-top:8px;">`;
    for (let r of recovering) {
      html += `<li><b>${r.policyNo}</b> ‚Äî ${r.name} ‚Äî ${r.monthsPaid} months ‚Äî RM ${r.anp.toFixed(2)} ‚Äî ${statusLabels[r.status]||r.status}</li>`;
    }
    html += `</ul></div>`;
  } else {
    html += `<div style="margin-top:12px; color:green;">‚úÖ Persistency target met.</div>`;
  }

  // Full listing (small)
  if (policies.length > 0) {
    html += `<div style="margin-top:14px;"><h4 style="margin:6px 0;">Full Policy Listing</h4><div style="font-size:12px;">`;
    html += `<table style="width:100%; border-collapse:collapse; font-size:12px;"><thead><tr style="background:${'#f7f8fa'}"><th style="padding:6px;border:1px solid ${'#eee'};text-align:left">Policy No</th><th style="padding:6px;border:1px solid ${'#eee'};text-align:left">Name</th><th style="padding:6px;border:1px solid ${'#eee'};text-align:left">Months</th><th style="padding:6px;border:1px solid ${'#eee'};text-align:right">ANP</th><th style="padding:6px;border:1px solid ${'#eee'};text-align:left">Status</th></tr></thead><tbody>`;
    for (let p of policies) {
      html += `<tr><td style="padding:6px;border:1px solid ${'#eee'}">${p.policyNo}</td><td style="padding:6px;border:1px solid ${'#eee'}">${p.name}</td><td style="padding:6px;border:1px solid ${'#eee'}">${p.monthsPaid}</td><td style="padding:6px;border:1px solid ${'#eee'};text-align:right">RM ${p.anp.toFixed(2)}</td><td style="padding:6px;border:1px solid ${'#eee'}">${p.status}</td></tr>`;
    }
    html += `</tbody></table></div></div>`;
  }

  resultEl.innerHTML = html;

  // If raw pane visible, refresh it
  const pre = document.getElementById("rawOutput");
  const toggleBtn = document.getElementById("toggleDebug");
  if (pre.style.display === "block") {
    pre.textContent = policies.map(p => `${p.policyNo}, ${p.name}, ${p.monthsPaid}, ${p.anp.toFixed(2)}, ${p.status}, ${p.persistencyBlock}, ${p.reportDate}`).join("\n");
    toggleBtn.textContent = "Hide Raw Persistency";
  } else {
    toggleBtn.textContent = "Show Raw Persistency";
  }
}

/* Toggle raw */
function toggleDebug(){
  const pre = document.getElementById("rawOutput");
  const btn = document.getElementById("toggleDebug");
  if (pre.style.display === "block") { pre.style.display="none"; btn.textContent="Show Raw Persistency"; return; }
  parseInputToPolicies();
  if (policies.length===0) pre.textContent = "No parsed policies found. Paste cleaned policy lines (CSV) into the input and press Calculate.";
  else pre.textContent = policies.map(p => `${p.policyNo}, ${p.name}, ${p.monthsPaid}, ${p.anp.toFixed(2)}, ${p.status}, ${p.persistencyBlock}, ${p.reportDate}`).join("\n");
  pre.style.display="block"; btn.textContent="Hide Raw Persistency";
}

/* ========== Generate PDF (jsPDF + AutoTable) ========== */
async function generateStructuredPDF(){
  // Ensure lastCalc has latest results
  if(!lastCalc || !lastCalc.policies || lastCalc.policies.length===0){
    // attempt parse and calculate quickly
    parseInputToPolicies();
    if(policies.length===0){ alert("No policies found. Paste cleaned CSV lines and press Calculate first."); return; }
    calculate();
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'mm', format:'a4', compress:true });
  const pageWidth = doc.internal.pageSize.getWidth();
  const marginLeft = 18;
  let cursorY = 18;

  // Header
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("Persistency Calculator Report", pageWidth/2, cursorY, { align:'center' });
  cursorY += 8;

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`Report Date: ${document.getElementById("reportDate").innerText.replace("Report Date: ","")}`, marginLeft, cursorY);
  doc.text(`Persistency Block: ${document.getElementById("persistBlock").innerText.replace("Persistency Block: ","")}`, marginLeft, cursorY + 6);
  // Agent on top-right
  doc.text(`Agent: ${document.getElementById("agentName").innerText.replace("Agent: ","")}`, pageWidth - marginLeft, cursorY, { align:'right' });

  cursorY += 14;

  // Summary area as small boxed values
  doc.setDrawColor(230);
  doc.setFillColor(255,255,255);
  const leftCol = marginLeft;
  const colW = (pageWidth - marginLeft*2 - 8) / 5;

  const s = lastCalc;
  const sumVals = [
    ["Total ANP", `RM ${s.totalANP.toFixed(2)}`],
    ["Persisted ANP", `RM ${s.persistedANP.toFixed(2)}`],
    ["Persistency %", `${s.roundedPersistency}%`],
    ["Target", `85%`],
    ["Status", `${s.roundedPersistency >=85 ? "Met" : "Not Met"}`]
  ];

  doc.setFontSize(9);
  for(let i=0;i<sumVals.length;i++){
    const x = leftCol + i*(colW + 2);
    doc.setFillColor(255,255,255);
    doc.roundedRect(x, cursorY, colW, 16, 3, 3, 'S');
    doc.setFont("helvetica","normal");
    doc.text(sumVals[i][0], x + 2, cursorY + 5);
    doc.setFont("helvetica","bold");
    doc.text(sumVals[i][1], x + 2, cursorY + 12);
  }
  cursorY += 22;

  // Shortfall block
  if (s.roundedPersistency < 85) {
    doc.setFillColor(255, 244, 230);
    doc.setDrawColor(255, 210, 150);
    doc.roundedRect(leftCol, cursorY, pageWidth - marginLeft*2, 10, 4, 4, 'FD');
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(`Shortfall: You need an additional RM ${ (s.shortfall>0? s.shortfall.toFixed(2): "0.00") } to reach 85%.`, leftCol + 4, cursorY + 7);
    cursorY += 16;
  } else {
    doc.setFontSize(10);
    doc.text("Persistency target is met.", leftCol, cursorY);
    cursorY += 8;
  }

  // Suggestion explanation
  cursorY += 4;
  doc.setFontSize(10);
  doc.setFont("helvetica","bold");
  doc.text("Logic Behind Suggested Policies:", leftCol, cursorY);
  cursorY += 6;
  doc.setFont("helvetica","normal");
  const logicText = "Suggested saveable policies are ranked by priority: Inforce policies with highest Months Paid first; then Lapsed policies, also sorted by Months Paid desc. This prioritizes policies with stronger payment history and higher likelihood of recovery.";
  const splitLogic = doc.splitTextToSize(logicText, pageWidth - marginLeft*2);
  doc.text(splitLogic, leftCol, cursorY);
  cursorY += (splitLogic.length * 5) + 4;

  // Suggested policies table (recovering)
  if (s.recovering && s.recovering.length>0) {
    doc.setFont("helvetica","bold");
    doc.text("Suggested Policies to Recover:", leftCol, cursorY);
    cursorY += 6;

    // Build table rows
    const head = [["Policy No","Name","Months Paid","Psist ANP","Status"]];
    const rows = s.recovering.map(p => [p.policyNo, p.name, String(p.monthsPaid), p.anp.toFixed(2), p.status]);

    doc.autoTable({
      startY: cursorY,
      head: head,
      body: rows,
      theme: 'grid',
      headStyles: { fillColor: [242,245,248], textColor: 20, fontStyle:'bold' },
      styles: { font: 'helvetica', fontSize:9, cellPadding:3 },
      margin: { left: leftCol, right: marginLeft },
      tableWidth: pageWidth - marginLeft*2,
      didDrawPage: function(data) { /* page hook handled below */ }
    });
    cursorY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 6 : cursorY + 10;
  }

  // Full policy listing (may span pages)
  doc.setFont("helvetica","bold");
  doc.text("Full Policy Listing:", leftCol, cursorY);
  cursorY += 6;

  const head2 = [["Policy No","Name","Months Paid","Psist ANP","Status"]];
  const rows2 = (s.policies || []).map(p => [p.policyNo, p.name, String(p.monthsPaid), p.anp.toFixed(2), p.status]);

  doc.autoTable({
    startY: cursorY,
    head: head2,
    body: rows2,
    theme: 'grid',
    headStyles: { fillColor: [242,245,248], textColor: 20, fontStyle:'bold' },
    styles: { font: 'helvetica', fontSize:9, cellPadding:3 },
    margin: { left: leftCol, right: marginLeft },
    tableWidth: pageWidth - marginLeft*2,
    // repeat header automatically via autoTable
    didDrawPage: function (data) {
      // footer: page number centered
      const page = doc.internal.getNumberOfPages();
      const totalPagesExp = "{total_pages_count_string}";
      doc.setFontSize(9);
      const footerText = `Generated by Persistency Calculator Tool ‚Äî Page ${page}`;
      doc.text(footerText, pageWidth/2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
    }
  });

  // Replace total pages placeholder (if plugin available)
  if (typeof doc.putTotalPages === 'function') {
    doc.putTotalPages("{total_pages_count_string}");
  }

  // Save PDF
  doc.save("persistency_report.pdf");
}
</script>
</body>
</html>
