<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="UTF-8" />
  <title>Persistency Calculator</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #1d1d1f;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 600px;
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    textarea, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #0071e3;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    button:hover {
      background: #005bb5;
    }
    #result {
      margin-top: 20px;
      text-align: left;
    }
    .guide {
      text-align: left;
      margin-top: 20px;
      border-radius: 8px;
      background-color: #e5f1ff;
      padding: 15px;
      color: #1d1d1f;
      border: 1px solid #0071e3;
    }
    summary {
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      padding: 10px;
      background-color: #f0f4ff;
      border-radius: 8px;
    }
    .guide-step {
      margin: 10px 0;
      line-height: 1.6;
    }
    details[open] summary {
      background-color: #dceeff;
      color: #0071e3;
    }
    .copy-button {
      background-color: #0071e3;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      margin-top: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .copy-button:hover {
      background-color: #005bb5;
    }
   @media (max-width: 768px) {
  .container {
    padding: 20px;
    margin: 10px;
  }
  h2 {
    font-size: 20px;
  }
  textarea {
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  body {
    padding: 10px;
  }
  .container {
    padding: 15px;
  }
  button {
    font-size: 14px;
    padding: 10px;
  }
}
    .suggestion-box {
      background-color: #fff4e5;
      border: 1px solid #ffa726;
      padding: 16px;
      border-radius: 10px;
      margin-top: 30px;
      text-align: left;
      color: #4e342e;
    }
    #pdfTitle {
      display: none;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="container" id="pdfContent">
    <h2>Persistency Calculator</h2>

    <label><b>Choose Persistency Type:</b></label><br>
    <select id="persistencyType">
      <option value="13">13-Month Persistency</option>
      <option value="12">12-Month Persistency</option>
    </select>

    <details>
      <summary>📘 Show Guide</summary>
      <div class="guide">
        <div class="guide-step"><strong>Step 1:</strong> Open the Manulife report (PDF or scanned text).</div>
        <div class="guide-step"><strong>Step 2:</strong> Copy the whole table content (including headers).</div>
        <div class="guide-step"><strong>Step 3:</strong> In ChatGPT, paste the content and type:</div>
        <pre style="margin-top: 10px; white-space: pre-wrap;">
<code id="hiddenPrompt">
Please extract the following details from the copied Manulife report:

Format:
PolicyNo, Name, MonthsPaid, PsistANP, Status, PersistencyBlock, ReportDate

Example:
00999998, MOU TAK DENG, 10, 3,600.00, LC, 01-JUN-2023 to 31-MAY-2024, 11/07/2025

Notes:
- Only include actual policies (skip totals or headers)
- PersistencyBlock = date range near top (e.g. "01-JUN-2023 to 31-MAY-2024")
- ReportDate = top-left corner date (e.g. "11/07/2025")
- Do not add thousand separators or commas to numbers. Keep numbers exactly as in the report (e.g. 3600.00, not 3,600.00)
</code>
</pre>
        <button class="copy-button" onclick="copyPrompt()">📋 Copy Prompt</button>
        <div class="guide-step"><strong>Step 4:</strong> Copy the cleaned result and paste it into the calculator below.</div>
      </div>
    </details>

    <textarea id="dataInput" rows="10" placeholder="Paste your cleaned result from ChatGPT here..."></textarea>
    <button onclick="calculate()">Calculate</button>
    <div id="pdfTitle">Persistency Calculator Report</div>
    <div id="result"></div>

    <!-- Hidden PDF Report Template -->
<div id="pdfReport" style="display:none; text-align:left; padding:50px; font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif; color:#111;">

  <!-- Header -->
  <div style="text-align:center; margin-bottom:40px;">
    <h1 style="margin:0; font-size:26px; font-weight:600; color:#111;">Persistency Calculator Report</h1>
    <p style="margin:5px 0; font-size:14px; color:#666;">
      Report Date: <span id="pdfReportDate"></span> • Persistency Block: <span id="pdfPersistencyBlock"></span>
    </p>
  </div>

  <!-- Executive Summary -->
  <div style="margin-bottom:40px;">
    <h2 style="font-size:18px; font-weight:600; border-bottom:1px solid #e0e0e0; padding-bottom:6px; margin-bottom:15px;">Executive Summary</h2>
    <p><b>Total ANP:</b> RM <span id="pdfTotalANP"></span></p>
    <p><b>Persisted ANP:</b> RM <span id="pdfPersistedANP"></span></p>
    <p><b>Persistency %:</b> <span id="pdfPersistency"></span></p>
    <p><b>Status:</b> <span id="pdfStatus"></span></p>
  </div>

  <!-- Shortfall Section -->
  <div id="pdfShortfallSection" style="margin-bottom:40px; display:none; padding:15px; border-radius:12px; background:#fff5f5; border:1px solid #ffd6d6;">
    <h2 style="font-size:18px; font-weight:600; margin-top:0; color:#c00;">Shortfall</h2>
    <p><b>Required Additional ANP:</b> RM <span id="pdfShortfall"></span></p>
  </div>

  <!-- Suggested Saveable Policies -->
  <div id="pdfSuggestions" style="margin-bottom:40px;"></div>

  <!-- Full Policy Listing -->
  <div id="pdfPolicyTable">
    <h2 style="font-size:18px; font-weight:600; border-bottom:1px solid #e0e0e0; padding-bottom:6px; margin-bottom:15px;">Full Policy Listing</h2>
    <table style="width:100%; border-collapse:collapse; font-size:13px;">
      <thead>
        <tr style="background:#f9f9f9; text-align:left;">
          <th style="padding:10px; border-bottom:1px solid #e0e0e0;">Policy No</th>
          <th style="padding:10px; border-bottom:1px solid #e0e0e0;">Name</th>
          <th style="padding:10px; border-bottom:1px solid #e0e0e0;">ANP</th>
          <th style="padding:10px; border-bottom:1px solid #e0e0e0;">Months Paid</th>
          <th style="padding:10px; border-bottom:1px solid #e0e0e0;">Status</th>
        </tr>
      </thead>
      <tbody id="pdfPolicyRows"></tbody>
    </table>
  </div>
</div>

    
    <button onclick="downloadPDF()">📄 Download Report as PDF</button>
  </div>

<script>
    function copyPrompt() {
        const code = document.getElementById("hiddenPrompt").innerText;
        navigator.clipboard.writeText(code).then(() => {
            const btn = document.querySelector(".copy-button");
            btn.textContent = "✅ Copied!";
            setTimeout(() => {
                btn.textContent = "📋 Copy Prompt";
            }, 2000);
        }).catch(() => {
            alert("❌ Copy failed. Please try again.");
        });
    }

    function calculate() {
        const raw = document.getElementById("dataInput").value.trim();
        if (!raw) {
            alert("Please paste your cleaned data first.");
            return;
        }

        const lines = raw.split("\n");
        const threshold = parseInt(document.getElementById("persistencyType").value);

        let totalANP = 0;
        let persistedANP = 0;
        let saveable = [];
        let unqualified = [];
        let reportDate = "";
        let block = "";

        const statusLabels = {
            "IP": "IP (inforce)",
            "LC": "LC (lapsed)",
            "LA": "LA (lapsed)",
            "TC": "TC (surrendered)"
        };

        for (let line of lines) {
            const parts = line.split(",").map(s => s.trim());
            if (parts.length < 7) continue;

            const [policyNo, name, monthsPaidStr, anpStr, status, blockStr, reportDateStr] = parts;

            const monthsPaid = parseInt(monthsPaidStr);
            const anp = parseFloat(anpStr.replace(/,/g, ''));

            if (!reportDate && reportDateStr) reportDate = reportDateStr;
            if (!block && blockStr) block = blockStr;

            if (isNaN(anp) || anp <= 0) continue;

            totalANP += anp;

            if (monthsPaid >= threshold) {
                persistedANP += anp;
            } else {
                saveable.push({ policyNo, name, monthsPaid, anp, status });
                unqualified.push({ policyNo, name, monthsPaid, anp, status });
            }
        }

        const manulifeRound = (value) => {
            let num = parseFloat(value.toFixed(4));
            num = parseFloat(num.toFixed(3));
            num = parseFloat(num.toFixed(2));
            num = parseFloat(num.toFixed(1));
            return num.toFixed(1);
        }

        const persistencyRaw = totalANP === 0 ? 0 : (persistedANP / totalANP) * 100;
        const roundedPersistency = manulifeRound(persistencyRaw);
        const targetANP = totalANP * 0.85;
        const shortfall = Math.max(targetANP - persistedANP, 0);

        // Prepare suggestion HTML
        let suggestionHTML = "";
        if (shortfall > 0 && saveable.length > 0) {
            saveable.sort((a, b) => {
                const prio = { "IP": 1, "LA": 2, "LC": 2 };
                const pa = prio[a.status] || 99;
                const pb = prio[b.status] || 99;
                if (pa !== pb) return pa - pb;
                if (b.monthsPaid !== a.monthsPaid) return b.monthsPaid - a.monthsPaid;
                return b.anp - a.anp;
            });

            suggestionHTML = "<h3>Suggested Saveable Policies</h3><ul>";
            let added = 0;
            for (let p of saveable) {
                if (added >= shortfall) break;
                added += p.anp;
                suggestionHTML += `<li><b>${p.policyNo}</b> – ${p.name} – RM ${p.anp.toLocaleString(undefined, { minimumFractionDigits: 2 })} – ${p.monthsPaid} months – ${statusLabels[p.status] || p.status}</li>`;
            }
            suggestionHTML += "</ul>";
        }

        // Update visible result
        let unqualifiedList = "<h4>📋 Unqualified Policies:</h4><ul>";
        unqualified.forEach(p => {
            unqualifiedList += `<li><b>${p.policyNo}</b> – ${p.name} – RM ${p.anp.toLocaleString(undefined, { minimumFractionDigits: 2 })} – ${p.monthsPaid} months – ${statusLabels[p.status] || p.status}</li>`;
        });
        unqualifiedList += "</ul>";

        document.getElementById("result").innerHTML = `
            <p><b>Total ANP:</b> RM ${totalANP.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
            <p><b>Persisted ANP (≥ ${threshold} months):</b> RM ${persistedANP.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
            <p><b>Persistency (Manulife Rule):</b> ${roundedPersistency}%</p>
            ${shortfall > 0 ? `<p>❌ Persistency below 85%. Shortfall: RM ${shortfall.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>` : "<p>✅ Persistency meets 85%</p>"}
            ${suggestionHTML}
            ${unqualifiedList}
        `;

        // Update PDF Summary Section
        document.getElementById("pdfTotalANP").textContent = totalANP.toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById("pdfPersistedANP").textContent = persistedANP.toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById("pdfPersistency").textContent = roundedPersistency + "%";
        document.getElementById("pdfReportDate").textContent = reportDate || "-";
        document.getElementById("pdfPersistencyBlock").textContent = block || "-";
        document.getElementById("pdfStatus").textContent = (persistencyRaw >= 85 ? "✅ Met" : "❌ Not Met");

        // Update PDF Shortfall Section (show/hide)
        if (shortfall > 0) {
            document.getElementById("pdfShortfallSection").style.display = "block";
            document.getElementById("pdfShortfall").textContent = shortfall.toLocaleString(undefined, { minimumFractionDigits: 2 });
        } else {
            document.getElementById("pdfShortfallSection").style.display = "none";
        }

        // Update PDF Suggestions Section
        document.getElementById("pdfSuggestions").innerHTML = suggestionHTML;

        // Update PDF Full Policy Table
        let rows = "";
        unqualified.forEach(p => {
            rows += `<tr>
                <td style="padding:6px; border:1px solid #ddd;">${p.policyNo}</td>
                <td style="padding:6px; border:1px solid #ddd;">${p.name}</td>
                <td style="padding:6px; border:1px solid #ddd;">RM ${p.anp.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                <td style="padding:6px; border:1px solid #ddd;">${p.monthsPaid}</td>
                <td style="padding:6px; border:1px solid #ddd;">${statusLabels[p.status] || p.status}</td>
            </tr>`;
        });
        document.getElementById("pdfPolicyRows").innerHTML = rows;

    }

   function downloadPDF() {
    const content = document.getElementById("pdfReport");
    const result = document.getElementById("result");

    if (!result.innerText.trim()) {
        alert("No result to download. Please run a calculation first.");
        return;
    }

    const title = document.getElementById("pdfTitle");
    title.style.display = "block";

    // --- Show hidden report before rendering ---
    content.style.display = "block";

    const opt = {
        margin: 0.5,
        filename: 'persistency_report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(content).save().then(() => {
        // --- Hide report again after export ---
        content.style.display = "none";
        title.style.display = "none";
    });
}

    // Auto-save / Restore Inputs
    window.addEventListener('DOMContentLoaded', function() {
        const dataInputEl = document.getElementById('dataInput');
        const persistencyTypeEl = document.getElementById('persistencyType');

        const savedInput = localStorage.getItem('persistencyDataInput');
        if (savedInput !== null && dataInputEl) {
            dataInputEl.value = savedInput;
        }

        const savedType = localStorage.getItem('persistencyType');
        if (savedType !== null && persistencyTypeEl) {
            persistencyTypeEl.value = savedType;
        }

        if (dataInputEl) {
            dataInputEl.addEventListener('input', function() {
                localStorage.setItem('persistencyDataInput', this.value);
            });
        }
        if (persistencyTypeEl) {
            persistencyTypeEl.addEventListener('change', function() {
                localStorage.setItem('persistencyType', this.value);
            });
        }
    });
</script>
</body>
</html>
